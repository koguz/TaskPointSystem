{% extends "tasks/base.html" %}
{% load static %}

{% block breadcrumbs %}
<div class="tps-view-head">
  <p class="tps-view-kicker">Student Workspace</p>
  <h1 class="tps-view-title">{{ team.course.masterCourse.compact_code }} / {{ team }}</h1>
  <p class="tps-view-subtitle">Track tasks, team performance, and current milestone progress</p>
</div>
{% endblock %}

{% block alert %}
{% if not user.email %}
<div class="alert alert-warning" role="alert">
  <strong>Email missing.</strong> Add an address in
  <a class="alert-link" href="{% url 'email' %}">profile settings</a>
  to receive task updates.
</div>
{% endif %}
{% endblock %}

{% block left_content %}
<section class="tps-section">
  <div class="tps-section-header">
    <h2 class="tps-section-title">Team Selector</h2>
  </div>
  <div class="tps-section-body">
    <select class="form-select mb-3" onchange="window.location.href=this.value">
      {% for t in teams %}
        {% if t.pk == team.pk and t.course.get_current_milestone is not None %}
        <option selected value="{% url 'team_view' t.pk %}">{{ t.course.masterCourse.compact_code }} / {{ t }}</option>
        {% elif t.course.get_current_milestone is not None %}
        <option value="{% url 'team_view' t.pk %}">{{ t.course.masterCourse.compact_code }} / {{ t }}</option>
        {% else %}
        <option value="{% url 'team_view' t.pk %}" disabled>{{ t.course.masterCourse.compact_code }} / {{ t }} (No active milestone)</option>
        {% endif %}
      {% endfor %}
    </select>

    <div class="d-grid gap-2">
      <a class="btn btn-outline-secondary" href="{{ team.github }}" target="_blank" rel="noopener noreferrer">
        <i class="bi bi-github"></i> Team Repository
      </a>
      <a class="btn btn-outline-secondary" href="{% url 'edit_team' team.pk %}">
        <i class="bi bi-pencil-square"></i> Edit Team
      </a>
      <a href="{% url 'create_task' team.pk %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Create Task
      </a>
    </div>
  </div>
</section>

<section class="tps-section">
  <div class="tps-section-header">
    <h2 class="tps-section-title">Team Milestone Points</h2>
  </div>
  <div class="tps-section-body">
    <ul class="tps-list-clean">
      {% for key, value in team.get_milestone_list.items %}
      <li class="d-flex justify-content-between align-items-center">
        <span>{{ key }}</span>
        <span class="badge bg-secondary">{{ value }}</span>
      </li>
      {% empty %}
      <li class="text-muted">No milestone data.</li>
      {% endfor %}
    </ul>
  </div>
</section>

<section class="tps-section">
  <div class="tps-section-header">
    <h2 class="tps-section-title">Developer Points</h2>
  </div>
  <div class="tps-section-body">
    <div class="tps-stack">
      {% for dev, value in developers.items %}
      <div class="tps-note-item">
        <span class="tps-note-label">{{ dev }}</span>
        <p class="tps-note-value mb-1">Overall Project: {{ value.0 }} points</p>
        <div class="small text-muted">
          {% for k, v in value.1.items %}
          <div>{{ k }}: {{ v }} points</div>
          {% endfor %}
        </div>
      </div>
      {% empty %}
      <div class="text-muted small">No developer data.</div>
      {% endfor %}
    </div>
  </div>
</section>
{% endblock %}

{% block main_content %}
<section class="tps-section">
  <div class="tps-section-header">
    <h2 class="tps-section-title">Recent Tasks</h2>
    <span class="text-muted small">{{ tasks|length }} items</span>
  </div>
  <div class="p-0">
    <div class="table-responsive table-responsive-md-stack">
      <table class="table tps-table-clean table-hover align-middle">
        <thead>
          <tr>
            <th scope="col">Owner</th>
            <th scope="col">Title</th>
            <th scope="col">Milestone</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody>
          {% for mtask in tasks %}
          <tr>
            <td>{{ mtask.owner }}</td>
            <td><a href="{% url 'view_task' mtask.pk %}">{{ mtask }}</a></td>
            <td>{{ mtask.milestone }}</td>
            <td>
              <span class="badge {% if mtask.status == 1 %}bg-warning text-dark{% elif mtask.status == 2 %}bg-primary{% elif mtask.status == 3 %}bg-info text-dark{% elif mtask.status == 4 %}bg-danger{% else %}bg-success{% endif %}">
                {{ mtask.getStatus }}
              </span>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="text-center text-muted py-4">No tasks yet for this team.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
{% endblock %}

{% block right_content %}
<section class="tps-section">
  <div class="tps-section-header">
    <h2 class="tps-section-title">Current Milestone</h2>
  </div>
  <div class="tps-section-body">
    {% if milestone %}
    <ul class="tps-note-list mb-3">
      <li class="tps-note-item">
        <span class="tps-note-label">Milestone</span>
        <p class="tps-note-value">{{ milestone }}</p>
      </li>
      <li class="tps-note-item">
        <span class="tps-note-label">Due Date</span>
        <p class="tps-note-value">{{ milestone.due }}</p>
      </li>
      <li class="tps-note-item">
        <span class="tps-note-label">Weight</span>
        <p class="tps-note-value">{{ milestone.weight }}</p>
      </li>
    </ul>
    <div class="small text-muted">{{ milestone.description|linebreaksbr }}</div>
    {% else %}
    <p class="text-muted mb-0">No active milestone.</p>
    {% endif %}
  </div>
</section>
{% endblock %}
