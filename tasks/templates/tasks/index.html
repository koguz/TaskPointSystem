{% extends "tasks/base.html" %}
{% load static %}
{% block layout_mode %}sidebar{% endblock %}

{% block breadcrumbs %}
<div class="tps-view-head">
  <p class="tps-view-kicker">Student Workspace</p>
  <h1 class="tps-view-title">{{ team.course.masterCourse.compact_code }} / {{ team }}</h1>
  <p class="tps-view-subtitle">Track tasks, team performance, and current milestone progress</p>
</div>

<section class="tps-section mt-3">
  <div class="tps-section-body">
    <div class="tps-team-toolbar">
      <select class="form-select tps-team-select" onchange="window.location.href=this.value">
        {% for t in teams %}
          {% if t.pk == team.pk %}
          <option selected value="{% url 'team_view' t.pk %}">{{ t.course.masterCourse.compact_code }} / {{ t }}</option>
          {% else %}
          <option value="{% url 'team_view' t.pk %}">{{ t.course.masterCourse.compact_code }} / {{ t }}</option>
          {% endif %}
        {% endfor %}
      </select>

      {% if course_active %}
      <a class="btn btn-outline-secondary" href="{% url 'edit_team' team.pk %}">
        <i class="bi bi-pencil-square"></i> Edit Team
      </a>
      {% else %}
      <button class="btn btn-outline-secondary" type="button" disabled>
        <i class="bi bi-pencil-square"></i> Edit Team
      </button>
      {% endif %}
      <a class="btn btn-outline-secondary" href="{{ team.github }}" target="_blank" rel="noopener noreferrer">
        <i class="bi bi-github"></i> Team Repository
      </a>
    </div>
  </div>
</section>
{% endblock %}

{% block alert %}
{% if not course_active %}
<div class="alert alert-secondary" role="alert">
  <strong>Course completed.</strong> This workspace is now read-only.
</div>
{% endif %}
{% endblock %}

{% block left_content %}

<section class="tps-section">
  <div class="tps-section-header">
    <h2 class="tps-section-title">Developer Points</h2>
    <a href="{% url 'team_points_detail' team.pk %}" class="btn btn-sm btn-outline-primary">
      <i class="bi bi-bar-chart-line"></i> View Breakdown
    </a>
  </div>
  <div class="tps-section-body">
    <div class="tps-stack">
      {% for dev, value in developers.items %}
      <div class="tps-note-item">
        <span class="tps-note-label">{{ dev }}</span>
        <p class="tps-note-value mb-1">Overall Project: {{ value.0 }} points</p>
        <div class="small text-muted">
          {% for k, v in value.1.items %}
          <div>{{ k }}: {{ v }} points</div>
          {% endfor %}
        </div>
      </div>
      {% empty %}
      <div class="text-muted small">No developer data.</div>
      {% endfor %}
    </div>
  </div>
</section>

<section class="tps-section">
  <div class="tps-section-header">
    <h2 class="tps-section-title">Current Milestone</h2>
  </div>
  <div class="tps-section-body">
    {% if milestone %}
    <ul class="tps-note-list mb-3">
      <li class="tps-note-item">
        <span class="tps-note-label">Milestone</span>
        <p class="tps-note-value">{{ milestone }}</p>
      </li>
      <li class="tps-note-item">
        <span class="tps-note-label">Due Date</span>
        <p class="tps-note-value">{{ milestone.due }}</p>
      </li>
      <li class="tps-note-item">
        <span class="tps-note-label">Weight</span>
        <p class="tps-note-value">{{ milestone.weight }}</p>
      </li>
    </ul>
    <div class="small text-muted">{{ milestone.description|linebreaksbr }}</div>
    {% else %}
    <p class="text-muted mb-0">No active milestone.</p>
    {% endif %}
  </div>
</section>

<section class="tps-section">
  <div class="tps-section-header">
    <h2 class="tps-section-title">Team Milestone Points</h2>
  </div>
  <div class="tps-section-body">
    <ul class="tps-list-clean">
      {% for key, value in team.get_milestone_list.items %}
      <li class="d-flex justify-content-between align-items-center">
        <span>{{ key }}</span>
        <span class="badge bg-secondary">{{ value }}</span>
      </li>
      {% empty %}
      <li class="text-muted">No milestone data.</li>
      {% endfor %}
    </ul>
  </div>
</section>


{% endblock %}

{% block main_content %}
<section class="tps-section">
  <div class="tps-section-header">
    <h2 class="tps-section-title">Tasks</h2>
    {% if course_active %}
    <a href="{% url 'create_task' team.pk %}" class="btn btn-sm btn-primary">
      <i class="bi bi-plus-circle"></i> Create Task
    </a>
    {% else %}
    <button type="button" class="btn btn-sm btn-secondary" disabled>
      <i class="bi bi-plus-circle"></i> Create Task
    </button>
    {% endif %}
  </div>
  <div class="p-0">
    <div class="table-responsive table-responsive-md-stack">
      <table class="table tps-table-clean table-hover align-middle">
        <thead>
          <tr>
            <th scope="col">Owner</th>
            <th scope="col">Title</th>
            <th scope="col">Milestone</th>
            <th scope="col">Due Date</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody>
          {% for mtask in tasks_page %}
          <tr>
            <td>{{ mtask.owner }}</td>
            <td><a href="{% url 'view_task' mtask.pk %}">{{ mtask }}</a></td>
            <td>{{ mtask.milestone }}</td>
            <td>{{ mtask.get_task.promised_date }}</td>
            <td>
              <span class="badge {% if mtask.status == 1 %}bg-warning text-dark{% elif mtask.status == 2 %}bg-primary{% elif mtask.status == 3 %}bg-info text-dark{% elif mtask.status == 4 %}bg-danger{% else %}bg-success{% endif %}">
                {{ mtask.getStatus }}
              </span>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center text-muted py-4">No tasks yet for this team.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if tasks_page.has_other_pages %}
    <nav class="p-3 border-top" aria-label="Task pagination">
      <ul class="pagination pagination-sm mb-0 justify-content-end">
        {% if tasks_page.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ tasks_page.previous_page_number }}">Previous</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">Page {{ tasks_page.number }} / {{ tasks_page.paginator.num_pages }}</span>
        </li>

        {% if tasks_page.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ tasks_page.next_page_number }}">Next</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
</section>
{% endblock %}
