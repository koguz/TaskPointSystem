{% extends "tasks/base.html" %}
{% load static tz %}
{% block layout_mode %}two{% endblock %}

{% block breadcrumbs %}
<div class="tps-view-head">
  <p class="tps-view-kicker">Developer Workspace</p>
  <h1 class="tps-view-title">
    <a href="{% url 'team_view' mastertask.team.pk %}" class="tps-view-title-link">{{ mastertask.team }}</a>
    <span class="tps-view-title-sep">&gt;</span>
    <span>{{ mastertask }}</span>
  </h1>
  <p class="tps-view-subtitle">Review task progress, vote, and collaborate with your team</p>
</div>
{% endblock %}

{% block main_left_content %}
<section class="tps-section">
  <div class="tps-section-header">
    <h2 class="tps-section-title"><i class="bi bi-list-task"></i> Task Summary</h2>
    <span class="badge {% if mastertask.status == 1 %}bg-warning text-dark{% elif mastertask.status == 2 %}bg-primary{% elif mastertask.status == 3 %}bg-info text-dark{% elif mastertask.status == 4 %}bg-danger{% else %}bg-success{% endif %}">
      {{ mastertask.getStatus }}
    </span>
  </div>
  <div class="tps-section-body">
    <p class="mb-2 text-muted"><i class="bi bi-person-check"></i> Assigned to {{ mastertask.owner }}</p>
    <p class="mb-3 text-muted"><i class="bi bi-calendar-check"></i> Due {{ task.promised_date }}</p>
    <div class="mb-3">{{ task.description|linebreaksbr }}</div>

    {% if not mytask %}
    <div class="d-flex flex-wrap gap-2 mb-3">
      <a href="{% url 'like_task' mastertask.pk 1 %}" class="btn {% if liked %}btn-success{% else %}btn-outline-success{% endif %} btn-sm">
        <i class="bi bi-hand-thumbs-up{% if liked %}-fill{% endif %}"></i> Like
      </a>
      <a href="{% url 'like_task' mastertask.pk 0 %}" class="btn {% if liked == False %}btn-danger{% else %}btn-outline-danger{% endif %} btn-sm">
        <i class="bi bi-hand-thumbs-down{% if liked == False %}-fill{% endif %}"></i> Dislike
      </a>
    </div>
    {% endif %}

    {% if mastertask.status == 1 and mytask %}
    <div class="alert alert-info py-2 mb-3">
      You can edit this task while in <strong>{{ mastertask.getStatus }}</strong> state.
      <a href="{% url 'edit_task' mastertask.pk %}" class="btn btn-sm btn-primary ms-2"><i class="bi bi-pencil-square"></i> Edit</a>
    </div>
    {% endif %}

    {% if mytask and revision_requested and mastertask.status == 1 %}
    <div class="alert alert-warning py-2 mb-3 d-flex flex-wrap align-items-center justify-content-between gap-2">
      <span><strong>Revision requested.</strong> Edit the task and save a new version so teammates can vote again.</span>
      <a href="{% url 'edit_task' mastertask.pk %}" class="btn btn-sm btn-warning">
        <i class="bi bi-pencil-square"></i> Edit Task
      </a>
    </div>
    {% endif %}

    {% if mytask %}
    {% if mastertask.status == 2 or mastertask.status == 3 and revision_requested %}
    {% if mastertask.status == 2 %}
    <div class="alert alert-primary py-2">Task is open. Submit completion details below.</div>
    {% else %}
    <div class="alert alert-warning py-2">Changes are requested for this completed task. Submit a completion update below to start a new voting round.</div>
    {% endif %}
    <form action="{% url 'complete_task' mastertask.pk %}" method="post" class="tps-form-grid">
      {% csrf_token %}
      <div>
        <label for="difficulty" class="form-label">Difficulty</label>
        <select id="difficulty" name="difficulty" class="form-select">
          <option value="1" {% if mastertask.difficulty == 1 %}selected{% endif %}>Easy</option>
          <option value="2" {% if mastertask.difficulty == 2 %}selected{% endif %}>Normal</option>
          <option value="3" {% if mastertask.difficulty == 3 %}selected{% endif %}>Difficult</option>
        </select>
      </div>
      <div>
        <label for="completionSummary" class="form-label">Completion Summary</label>
        <textarea
          id="completionSummary"
          name="completion_summary"
          class="form-control"
          rows="4"
          placeholder="Explain what you completed, what changed, and what teammates should review."
          required
        ></textarea>
      </div>
      <div>
        <label for="completionFileUrl" class="form-label">Git Commit or File URL</label>
        <input
          id="completionFileUrl"
          type="url"
          name="completion_file_url"
          class="form-control"
          placeholder="https://github.com/..."
          required
        />
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="used_ai" id="tvUsedAi" />
        <label class="form-check-label" for="tvUsedAi">I used generative AI for this task</label>
      </div>
      <div id="tvAiUsageOptions" class="d-none ps-3 border-start">
        <div class="form-check"><input class="form-check-input" type="checkbox" name="ai_usage" value="Code generation" id="aiCode" /><label class="form-check-label" for="aiCode">Code generation</label></div>
        <div class="form-check"><input class="form-check-input" type="checkbox" name="ai_usage" value="Debugging/troubleshooting" id="aiDebug" /><label class="form-check-label" for="aiDebug">Debugging/troubleshooting</label></div>
        <div class="form-check"><input class="form-check-input" type="checkbox" name="ai_usage" value="Writing tests" id="aiTests" /><label class="form-check-label" for="aiTests">Writing tests</label></div>
        <div class="form-check"><input class="form-check-input" type="checkbox" name="ai_usage" value="Documentation" id="aiDocs" /><label class="form-check-label" for="aiDocs">Documentation</label></div>
        <div class="form-check"><input class="form-check-input" type="checkbox" name="ai_usage" value="Research/learning" id="aiResearch" /><label class="form-check-label" for="aiResearch">Research/learning</label></div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-success">
          <i class="bi bi-check2-circle"></i>
          {% if mastertask.status == 2 %}Mark Completed{% else %}Submit Completion Update{% endif %}
        </button>
      </div>
    </form>
    {% endif %}
    {% endif %}

    <div class="tps-mini-grid mt-3">
      <div class="tps-mini-card">
        <p class="tps-mini-label">Priority</p>
        <p class="tps-mini-value">{{ task.getPriority }}</p>
      </div>
      <div class="tps-mini-card">
        <p class="tps-mini-label">Points</p>
        <p class="tps-mini-value">{% if mastertask.status > 2 %}{{ task.priority }} x {{ mastertask.difficulty }} = {{ tp }}{% else %}Pending completion{% endif %}</p>
      </div>
      <div class="tps-mini-card">
        <p class="tps-mini-label">Difficulty</p>
        <p class="tps-mini-value">{% if mastertask.status > 2 %}{{ mastertask.getDifficulty }}{% else %}Not set yet{% endif %}</p>
      </div>
      <div class="tps-mini-card">
        <p class="tps-mini-label">Version / Votes</p>
        <p class="tps-mini-value">v{{ task.version }} Â· {{ v_app }} / {{ v_den }}</p>
      </div>
      {% if mastertask.used_ai %}
      <div class="tps-mini-card" style="grid-column: 1 / -1">
        <p class="tps-mini-label"><i class="bi bi-robot"></i> Generative AI Usage</p>
        <p class="tps-mini-value">{{ mastertask.ai_usage }}</p>
      </div>
      {% endif %}
    </div>
  </div>
</section>

<section class="tps-section mb-0">
  <div class="tps-section-header">
    <h2 class="tps-section-title">Task History</h2>
  </div>
  <div class="tps-section-body">
    <div class="tps-stack">
      {% for log in logs %}
      <div class="tps-note-item{% if 'revision request' in log.log|lower %} tps-note-item-revision{% endif %}">
        <span class="tps-note-label">{{ log.tarih|localtime }}</span>
        <p class="tps-note-value mb-1">{{ log.taskstatus }}</p>
        <div class="small">{{ log.log }}</div>
      </div>
      {% empty %}
      <div class="text-muted">No log entries.</div>
      {% endfor %}
    </div>
  </div>
</section>
{% endblock %}

{% block main_right_content %}
<section class="tps-section">
  <div class="tps-section-header">
    <h2 class="tps-section-title">Feedback & Decision</h2>
  </div>
  <div class="tps-section-body">
    <form action="{% url 'view_task' mastertask.pk %}" method="post" class="tps-form-grid">
      {% csrf_token %}
      {{ form.as_p }}
      <div class="form-actions">
        <button class="btn btn-primary" type="submit" name="approve" value="C">
          <i class="bi bi-chat-right"></i> Comment
        </button>

        {% if voted == 0 and not mytask and mastertask.status < 4 and mastertask.status != 2 %}
        <button class="btn btn-success" type="submit" name="approve" value="Yes">
          <i class="bi bi-check-square"></i> Approve
        </button>
        <button class="btn btn-danger" type="submit" name="approve" value="No">
          <i class="bi bi-x-square"></i> Request Revision
        </button>
        {% endif %}
      </div>
    </form>
  </div>
</section>

<section class="tps-section mb-0">
  <div class="tps-section-header">
    <h2 class="tps-section-title">Discussion</h2>
    <span class="text-muted small">{{ comments|length }} entries</span>
  </div>
  <div class="tps-section-body">
    <div class="tps-stack">
      {% for comment in comments %}
      <article class="tps-comment {% if comment.is_completion_update %}completion{% elif comment.approved %}approve{% elif comment.approved == False %}revise{% endif %}">
        <div class="tps-comment-head">
          <p class="tps-comment-author">
            <i class="bi bi-chat-right"></i> {{ comment.owner.get_full_name }}
            {% if comment.is_completion_update %}
            <span class="badge bg-success ms-2">Completion Update</span>
            {% endif %}
          </p>
          <span class="tps-comment-time">{{ comment.date }}</span>
        </div>
        <p class="tps-comment-text">{{ comment.body|linebreaksbr }}</p>
        {% if comment.file_url %}
        <div class="small mt-2">
          <a href="{{ comment.file_url }}" target="_blank" rel="noopener noreferrer">Attachment link</a>
        </div>
        {% endif %}
      </article>
      {% empty %}
      <div class="empty-state">No comments yet.</div>
      {% endfor %}
    </div>
  </div>
</section>
{% endblock %}

{% block scriptblock %}
{{ block.super }}
<script>
  (function () {
    const aiToggle = document.getElementById("tvUsedAi");
    const aiOptions = document.getElementById("tvAiUsageOptions");

    if (!aiToggle || !aiOptions) {
      return;
    }

    const syncAiOptions = () => {
      aiOptions.classList.toggle("d-none", !aiToggle.checked);
    };

    aiToggle.addEventListener("change", syncAiOptions);
    syncAiOptions();
  })();
</script>
{% endblock %}
